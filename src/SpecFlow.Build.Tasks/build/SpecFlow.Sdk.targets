<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- This ensures that msbuild will rebuild this project if the props/targets file changes -->
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <SpecFlowTrace Condition=" '$(SpecFlowTrace)' == '' ">false</SpecFlowTrace>
    <SpecFlowVerbose Condition=" '$(SpecFlowVerbose)' == '' ">false</SpecFlowVerbose>
    <SpecFlowIntermediateOutputPath Condition=" '$(SpecFlowIntermediateOutputPath)' == '' ">$(IntermediateOutputPath)specflow\</SpecFlowIntermediateOutputPath>
  </PropertyGroup>

  <Import Project="SpecFlow.Sdk.DefaultItems.targets" />
  <Import Project="SpecFlow.Sdk.DesignTime.targets" />

  <UsingTask TaskName="SpecFlow.Build.Tasks.GenerateSpecFlowFeatureFiles" AssemblyFile="$(SpecFlowBuildTasksAssembly)" />

  <PropertyGroup>
    <BuildDependsOn>
      GenerateSpecFlowFeature;
      AddSpecFlowGeneratedFeature;
      $(BuildDependsOn);
    </BuildDependsOn>
    <CleanDependsOn>
      CleanSpecFlowGeneratedFeature;
      $(CleanDependsOn);
    </CleanDependsOn>
  </PropertyGroup>

  <Target Name="GenerateSpecFlowFeature" Inputs="@(SpecFlowFeature)" Outputs="@(SpecFlowFeature->'%(Identity).cs')">
    <!-- TODO: This task ends up reading the msbuild project to get settings. Pass them in instead. -->
    <GenerateSpecFlowFeatureFiles ShowTrace="$(SpecFlowTrace)"
                                  VerboseOutput="$(SpecFlowVerbose)"
                                  ProjectPath="$(MSBuildProjectFullPath)"
                                  FeatureFiles="@(SpecFlowFeature)">
      <Output TaskParameter="GeneratedFiles" ItemName="SpecFlowGeneratedFile" />
    </GenerateSpecFlowFeatureFiles>
  </Target>

  <Target Name="AddSpecFlowGeneratedFeature">
    <ItemGroup>
      <!-- Deduplicate the generated files from the ones picked up directly by the default glob -->
      <Compile Remove="@(SpecFlowFeature->'%(Identity).cs')" />
      <Compile Include="@(SpecFlowFeature->'%(Identity).cs')">
        <Visible>false</Visible>
      </Compile>
      <FileWrite Include="@(SpecFlowFeature->'%(Identity).cs')" />
    </ItemGroup>
  </Target>

  <Target Name="CleanSpecFlowGeneratedFeature">
    <Delete Files="**/*$(DefaultSpecFlowGeneratedFeatureExtension)" ContinueOnError="true" />
  </Target>

</Project>
