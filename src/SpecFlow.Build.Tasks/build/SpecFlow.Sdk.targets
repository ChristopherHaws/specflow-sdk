<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- This ensures that msbuild will rebuild this project if the props/targets file changes -->
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <SpecFlowTrace Condition=" '$(SpecFlowTrace)' == '' ">false</SpecFlowTrace>
    <SpecFlowVerbose Condition=" '$(SpecFlowVerbose)' == '' ">false</SpecFlowVerbose>
    <SpecFlowIntermediateOutputPath Condition=" '$(SpecFlowIntermediateOutputPath)' == '' ">$(IntermediateOutputPath)specflow\</SpecFlowIntermediateOutputPath>
  </PropertyGroup>

  <!-- Default item includes (globs and implicit references) -->
  <Import Project="SpecFlow.Sdk.DefaultItems.targets" />

  <UsingTask TaskName="SpecFlow.Build.Tasks.GenerateSpecFlowFeatureFiles" AssemblyFile="$(SpecFlowBuildTasksAssembly)" />

  <PropertyGroup>
    <BuildDependsOn>
      GenerateSpecFlowFeatureFiles;
      AddSpecFlowGeneratedFeatureFiles;
      $(BuildDependsOn);
    </BuildDependsOn>
    <CleanDependsOn>
      CleanSpecFlowGeneratedFeatureFiles;
      $(CleanDependsOn);
    </CleanDependsOn>
  </PropertyGroup>

  <Target Name="GenerateSpecFlowFeatureFiles" Inputs="@(SpecFlowFeatureFile)" Outputs="@(SpecFlowFeatureFile->'%(Identity).cs')">
    <!-- TODO: This task ends up reading the msbuild project to get settings. Pass them in instead. -->
    <GenerateSpecFlowFeatureFiles ShowTrace="$(SpecFlowTrace)"
                                  VerboseOutput="$(SpecFlowVerbose)"
                                  ProjectPath="$(MSBuildProjectFullPath)"
                                  FeatureFiles="@(SpecFlowFeatureFile)">
      <Output TaskParameter="GeneratedFiles" ItemName="SpecFlowGeneratedFile" />
    </GenerateSpecFlowFeatureFiles>
  </Target>

  <Target Name="AddSpecFlowGeneratedFeatureFiles">
    <ItemGroup>
      <!-- Deduplicate the generated files from the ones picked up directly by the default glob -->
      <Compile Remove="@(SpecFlowFeatureFile->'%(Identity).cs')" />
      <Compile Include="@(SpecFlowFeatureFile->'%(Identity).cs')">
        <Visible>false</Visible>
      </Compile>
      <FileWrite Include="@(SpecFlowFeatureFile->'%(Identity).cs')" />
    </ItemGroup>
  </Target>

  <Target Name="CleanSpecFlowGeneratedFeatureFiles">
    <Delete Files="**/*$(DefaultSpecFlowGeneratedFeatureExtension)" ContinueOnError="true" />
  </Target>

</Project>
